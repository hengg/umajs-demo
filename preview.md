
## ç®€ä»‹
Umajs æ˜¯ä¸€ä¸ªç®€å•æ˜“ç”¨ã€æ‰©å±•çµæ´»ï¼ŒåŸºäº TypeScript çš„ Node.js Web æ¡†æ¶ã€‚

ä» 2018 å¹´ç«‹é¡¹è‡³ä»Šï¼ŒUmajs å›¢é˜ŸæŒç»­çš„å¯¹æ¡†æ¶æ‰“ç£¨ã€è¿­ä»£ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œè¿‘ä¸¤å¹´åï¼Œäº 2020 å¹´ 8 æœˆä»½å¼€æºã€‚

è¯´åˆ°è¿™å„¿å„ä½æœ‹å‹æ²¡å‡†å„¿æƒ³é—®ï¼šè¿™ä¸ªæ¡†æ¶æ˜¯æ€ä¹ˆä¸ªç®€å•æ˜“ç”¨æ³•ï¼Ÿæ‰©å±•çµæ´»æ˜¯ä¸æ˜¯å¼€å‘å›¢é˜Ÿè‡ªå·±å¹çš„ï¼Ÿ

æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¸¦ç€è¿™ä¸¤ä¸ªç–‘é—®ä¸€èµ·å¾€ä¸‹èµ°ï¼Œçœ‹çœ‹ Umajs åˆ°åº•æ˜¯ä¸æ˜¯çœŸçš„åšåˆ°äº†ç®€å•ã€çµæ´»ã€‚

## æ ¸å¿ƒä¼˜åŠ¿
é¦–å…ˆï¼ŒUmajs çš„æ ¸å¿ƒä¼˜åŠ¿ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

- **å‚æ•°è£…é¥°å™¨** å†…ç½®ä¸°å¯Œçš„å‚æ•°è£…é¥°å™¨ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒè‡ªå®šä¹‰å‚æ•°è£…é¥°å™¨ï¼›é€šè¿‡å‚æ•°è£…é¥°å™¨å¯ä»¥å¿«é€Ÿçš„æå–ã€æ ¡éªŒã€è½¬æ¢ã€èšåˆç”¨æˆ·è¾“å…¥ä¸ºæˆ‘ä»¬æ‰€éœ€è¦çš„æ ¼å¼ï¼›
- **ç»Ÿä¸€è¿”å›** é€šè¿‡ç»Ÿä¸€è¿”å›æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿçš„å¯¹è¿”å›ç»“æœè¿›è¡Œä¿®æ”¹ï¼›å½“ç„¶æ¡†æ¶ä¹Ÿæ”¯æŒæ™®é€šçš„è¿”å›æ–¹å¼ï¼›
- **åˆ‡é¢** è¿ç”¨åˆ‡é¢æœºåˆ¶å¯ä»¥æ˜¾è‘—æé«˜ä»£ç çš„å¯å¤ç”¨æ€§ã€é™ä½ä¸šåŠ¡é€»è¾‘ä¹‹é—´çš„è€¦åˆåº¦ï¼›Umajs å¯ä»¥è½»æ¾çš„å°†ä¸­é—´ä»¶è½¬æ¢ä¸ºåˆ‡é¢æ–¹æ³•ä»¥ä¾¿äºå¤ç”¨ Koa ç¤¾åŒºä¸°å¯Œçš„ä¸­é—´ä»¶èµ„æºï¼›
- **ä¾èµ–æ³¨å…¥** ä¾èµ–æ³¨å…¥åœ¨é™ä½ä¸šåŠ¡é€»è¾‘è€¦åˆåº¦çš„åŒæ—¶ï¼Œè¿˜å¯¹æ€§èƒ½æœ‰ä¸€å®šçš„æå‡ï¼›

ç»è¿‡ä¸Šè¿°ä¸€ç•ªä»‹ç»ï¼Œç›¸ä¿¡å„ä½å¯¹ Umajs æœ‰äº†äº›è®¸å°è±¡ï¼šä»€ä¹ˆè£…é¥°å™¨ã€AOPã€IOC å †åœ¨ä¸€èµ·ï¼Œè¿˜æœ‰ä¸ªæ²¡æ€ä¹ˆå¬è¯´è¿‡çš„ç»Ÿä¸€è¿”å›ã€‚

å¼€å‘å›¢é˜Ÿä¸ºä»€ä¹ˆæŠŠè¿™äº›ç‰¹æ€§ç§°ä¹‹ä¸º Umajs çš„æ ¸å¿ƒä¼˜åŠ¿ï¼Ÿè¿™äº›æ‰€è°“çš„ä¼˜åŠ¿æœ‰æ˜¯æ€ä¹ˆå¸®åŠ©æˆ‘ä»¬æå‡å¼€å‘æ•ˆç‡çš„å‘¢ï¼Ÿ

å£è¯´æ— å‡­ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥é€šè¿‡ç¤ºä¾‹ä»£ç äº†è§£ä¸€ä¸‹ã€‚

## å¤„ç†ç”¨æˆ·è¾“å…¥
å¼€å§‹ä¹‹å‰æˆ‘ä»¬å…ˆå¯¹ Controller çš„åŠŸèƒ½åšä¸€ä¸ªç®€å•çš„å®šä¹‰ï¼š å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œè¿”å›å¤„ç†ç»“æœç»™ç”¨æˆ·ã€‚

è€Œ Umajs å†…ç½®äº†ä¸°å¯Œçš„è£…é¥°å™¨ç”¨äºå¤„ç†ç”¨æˆ·çš„è¾“å…¥ã€‚
### æ•°æ®è·å–
ä¸¾ä¾‹æ¥è¯´æœ‰å¦‚ä¸‹è¯·æ±‚ï¼š

```
    GET /users/10269?role=admin
```
ä¸Šè¿°è¯·æ±‚å¯¹åº”çš„è·¯ç”± `path` æ˜¯ `/users/:id`,`role=admin` æ˜¯è¿™ä¸ªè¯·æ±‚çš„ QueryStringã€‚

åœ¨ Umajs ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡å†…ç½®çš„å‚æ•°è£…é¥°å™¨ `@Param` è·å–è·¯ç”±å‚æ•°ï¼Œé€šè¿‡ `@Query` è·å– QueryString ä¸Šçš„ valueï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š

```ts
// controller/index.controller.ts
@Path('/users/:id')
getUser(@Param('id') uid: string, @Query('role') role: string) {    
    // æŸ¥è¯¢è¿‡ç¨‹ç•¥
    return Result.json({ uid, role });
}
```
å‚æ•°è£…é¥°å™¨ `@Param('id') uid: string` çš„å‚æ•° `id` ä»£è¡¨å¾…è·å–å‚æ•°çš„ keyï¼Œè¿”å›å€¼ `uid` ä»£è¡¨å¾…è·å–å‚æ•°çš„ valueï¼Œè¿”å›å€¼å¯ä»¥ç›´æ¥åœ¨æ–¹æ³•é‡Œä½¿ç”¨ã€‚

åŒæ ·çš„ï¼Œå¯¹äº `POST` è¯·æ±‚ï¼Œæ¡†æ¶æä¾›äº† `@Body` è£…é¥°å™¨æ¥å¿«æ·è·å–bodyæ•°æ®ã€‚

é€šè¿‡æ¡†æ¶å†…ç½®çš„è¿™äº›å‚æ•°è£…é¥°å™¨è·å–å‚æ•°ç§°çš„ä¸Šæ˜¯è½»å·§å¿«æ·äº†ï¼Œä½†æ˜¯å‚æ•°è£…é¥°å™¨çš„åŠŸèƒ½ä¸ä»…äºæ­¤ï¼Œæ¡†æ¶è¿˜æä¾›äº†è‡ªå®šä¹‰å‚æ•°è£…é¥°å™¨çš„åŠŸèƒ½ä»¥ä¾¿äºé’ˆå¯¹ä¸åŒçš„ä¸šåŠ¡åœºæ™¯åšå®šåˆ¶åŒ–å¤„ç†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•å®ç°è‡ªå®šä¹‰å‚æ•°è£…é¥°å™¨ï¼š
```ts
// decorator/MyQuery.ts
import { createArgDecorator, IContext } from '@umajs/core';

export const MyQuery = createArgDecorator(
    (ctx: IContext, key: string) => ctx.query[key],
);
```
é€šè¿‡ç¤ºä¾‹ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ `createArgDecorator` èƒ½å¤Ÿå¾ˆè½»æ¾çš„åˆ›å»ºè‡ªå®šä¹‰å‚æ•°è£…é¥°å™¨ï¼šå®ƒæ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¿™ä¸ªå‡½æ•°æœ‰ `context` å’Œ `key` ä¸¤ä¸ªå‚æ•°ï¼Œ`key` ä½œä¸ºä¸€ä¸ªå¯é€‰å‚æ•°ä»£è¡¨æˆ‘ä»¬æƒ³åœ¨è‡ªå®šä¹‰å‚æ•°è£…é¥°å™¨ä¸­è·å–çš„å‚æ•°å­—æ®µï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨ `context` ä¸Šè·å–ç›¸åº”çš„æ•°æ®ã€‚ç¤ºä¾‹ä»£ç å®ç°äº†ä¸€ä¸ªç®€æ˜“çš„ `@Query` å‚æ•°è£…é¥°å™¨ï¼Œå®é™…åº”ç”¨ä¸­æˆ‘ä»¬èƒ½åšçš„åŠŸèƒ½ä¸æ­¢äºæ­¤ã€‚

### æ•°æ®æ£€æŸ¥ä¸è½¬æ¢

```ts
// decorator/AgeCheck.ts
export const AgeCheck = createArgDecorator(
    (ctx: IContext, ageKey: string) => {
        let age = ctx.query[ageKey];

        if (age === undefined) {
            return Result.json({
                code: 0,
                msg: 'è¯·åŠ ä¸Š age å‚æ•°',
            });
        }

        age = +age;

        if (Number.isNaN(age) || age < 0 || age > 120) {
            return Result.json({
                code: 0,
                msg: 'è¯·ä¼ å…¥æ­£ç¡®çš„ age å‚æ•°',
            });
        }
        return age;
    }
);
```
åœ¨è¿™æ®µç¤ºä¾‹ä¸­æˆ‘ä»¬å¯¹è¾“å…¥çš„å¹´é¾„æ•°æ®è¿›è¡Œäº†æå–ä¸æ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰ä¼ é€’å¹´é¾„å‚æ•°ã€æˆ–è€…ä¼ é€’çš„å¹´é¾„å‚æ•°ä¸ç¬¦åˆé¢„æœŸï¼Œåˆ™è¿”å›ç›¸åº”çš„æç¤ºä¿¡æ¯ç»™ç”¨æˆ·ã€‚æ¨è€Œå¹¿ä¹‹ï¼Œæˆ‘ä»¬åœ¨å®é™…åº”ç”¨ä¸­å¯ä»¥å¯¹ä»»ä½•éœ€è¦æ£€æŸ¥çš„å­—æ®µä½¿ç”¨è‡ªå®šä¹‰å‚æ•°è£…é¥°å™¨è¿›è¡Œæ ¡éªŒï¼Œè€Œè¿™äº›æ ¡éªŒé€»è¾‘æ˜¯å¯ä»¥è½»æ¾å¤ç”¨çš„ã€‚

åœ¨å®é™…åº”ç”¨ä¸­æˆ‘ä»¬è¿˜æœ‰å¦‚ä¸‹åœºæ™¯ï¼Œå‰ç«¯ä¼ é€’çš„æ˜¯ yyyy-MM-dd æ ¼å¼çš„æ—¥æœŸæ•°æ®ï¼Œè€Œæ•°æ®åº“æˆ–è€…ç¬¬ä¸‰æ–¹æœåŠ¡éœ€è¦çš„æ˜¯æ—¶é—´æˆ³æ ¼å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è‡ªå®šä¹‰å‚æ•°è£…é¥°å™¨ä¸­å¯¹å…¶è¿›è¡Œè½¬æ¢ï¼š

```TS
// decorator/DateCheck.ts
export const DateCheck = createArgDecorator(
    (ctx: IContext, dateKey: string) => {
        const dateStr = ctx.query[dateKey];
        // è½¬æ¢ yyyyMMdd ä¸ºæ—¶é—´æˆ³
        return dateStrToTimestamp(dateStr);
    },
);
```

æœ‰äº†ä»¥ä¸Šä¸¤ä¸ªå‚æ•°è£…é¥°å™¨ï¼Œ`GET /age?age=22&date=2020-10-10` è¿™ä¸ªè¯·æ±‚æˆ‘ä»¬å°±å¯ä»¥åœ¨ Controller çš„æ–¹æ³•ä¸­ä½¿ç”¨å®ƒä»¬æ¥è¿›è¡Œæ•°æ®æ£€æŸ¥ä¸è½¬æ¢ï¼Œè€Œ Controller æ–¹æ³•åˆ™ä¸“æ³¨äºå…·ä½“ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ï¼Œä»è€Œå®ç°å…³æ³¨ç‚¹åˆ†ç¦»ï¼š

```ts
@Path('/age')
age(@AgeCheck('age') age: number, @DateCheck('date') date: string) {
    return Result.send(`date is ${date}, age is ${age}`);
}
```

å®é™…ä¸Šé™¤äº† `@Param`ã€`@Query` å¤–ï¼ŒUmajs è¿˜é€šè¿‡æ‰©å±•åŒ… `@umajs/arg-decorator` æä¾›äº†ä¸°å¯Œçš„å¸¸ç”¨å‚æ•°è£…é¥°å™¨ï¼š

|ä¿®é¥°å™¨| ä½¿ç”¨è¯´æ˜ | 
---|---
@Body(id?:string or Function or string[]) | POSTè¯·æ±‚å‚æ•°ä¿®é¥°å™¨ `@Body() body:object `  or `@Body('id') id:any` or  `@Body(['name','age']) user: {name:any,age:any}` 
@Require(id: string,message?:string) | urlå‚æ•°ä¿®é¥°å¹¶åšå¿…å¡«æ ¡éªŒ
@ToNumber(id: string,message?: string) | å‚æ•°ä¿®é¥°å¹¶ç±»å‹è½¬æ¢ä¸ºnumberç±»å‹  ç±»å‹è½¬æ¢å¤±è´¥åˆ™ä¼šç»ˆæ­¢å‡½æ•°æ‰§è¡Œå¹¶è¿”å›æç¤ºå†…å®¹
@ToBoolean(id: string,message?: string) |å‚æ•°ä¿®é¥°å¹¶ç±»å‹è½¬æ¢å¸ƒå°”ç±»å‹ ç±»å‹è½¬æ¢å¤±è´¥åˆ™ä¼šç»ˆæ­¢å‡½æ•°æ‰§è¡Œå¹¶è¿”å›æç¤ºå†…å®¹
@ToArray(id: string, split?:string ,message?: string) |å‚æ•°ä¿®é¥°å¹¶ç±»å‹è½¬æ¢æ•°ç»„ ç±»å‹è½¬æ¢å¤±è´¥åˆ™ä¼šç»ˆæ­¢å‡½æ•°æ‰§è¡Œå¹¶è¿”å›æç¤ºå†…å®¹
@ToDate(id: string,message?: string) | å‚æ•°ä¿®é¥°å¹¶ç±»å‹è½¬æ¢ä¸ºdateç±»å‹  ç±»å‹è½¬æ¢å¤±è´¥åˆ™ä¼šç»ˆæ­¢å‡½æ•°æ‰§è¡Œå¹¶è¿”å›æç¤ºå†…å®¹ å¤‡æ³¨ï¼šå‚æ•°æ¥å—å¦‚æœä¸ºæ•°å­—ä¹Ÿä¼šæŒ‰ç…§æ—¶é—´å¼ºåˆ¶è½¬æ¢ä¸ºæ—¶é—´æ ¼å¼ã€‚
@Equals(id: string,comparison?: any) | å‚æ•°ä¿®é¥°å¹¶åšå€¼å¯¹æ¯”æ ¡éªŒ
@NotNull(id: string,message?: string) |	é™åˆ¶å¿…é¡»ä¸ä¸ºnull 
@AssertFalse(id: string,message?: string) |		é™åˆ¶å¿…é¡»ä¸ºfalse
@AssertTrue(id: string,message?: string)	 |	é™åˆ¶å¿…é¡»ä¸ºtrue
@DecimalMax(id: string,value: number,message?: string) |		é™åˆ¶å¿…é¡»ä¸ºä¸€ä¸ªä¸å¤§äºæŒ‡å®šå€¼çš„æ•°å­—
@DecimalMin(id: string,value: number,message?: string) |		é™åˆ¶å¿…é¡»ä¸ºä¸€ä¸ªä¸å°äºæŒ‡å®šå€¼çš„æ•°å­—
@Future(id: string,message?: string)	 |	é™åˆ¶å¿…é¡»æ˜¯ä¸€ä¸ªå°†æ¥çš„æ—¥æœŸ
@Max(id: string,value: number,message?: string)	 |	é™åˆ¶å¿…é¡»ä¸ºä¸€ä¸ªä¸å¤§äºæŒ‡å®šå€¼çš„æ•°å­—
@Min(id: string,value: number,message?: string)	 |	é™åˆ¶å¿…é¡»ä¸ºä¸€ä¸ªä¸å°äºæŒ‡å®šå€¼çš„æ•°å­—
@Past(id: string,message?: string)	 |	é™åˆ¶å¿…é¡»æ˜¯ä¸€ä¸ªè¿‡å»çš„æ—¥æœŸ
@Pattern(id: string,pattern: RegExp,message?: string)	 |	é™åˆ¶å¿…é¡»ç¬¦åˆæŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼
@Size(id: string,max: number,min: number,message?: string)	 |	é™åˆ¶å­—ç¬¦é•¿åº¦å¿…é¡»åœ¨minåˆ°maxä¹‹é—´
@NotEmpty(id: string,message?: string) 	 |		éªŒè¯æ³¨è§£çš„å…ƒç´ å€¼ä¸ä¸ºnullä¸”ä¸ä¸ºç©ºï¼ˆå­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º0ã€é›†åˆå¤§å°ä¸ä¸º0ï¼‰
@NotBlank(id: string,message?: string)	 |	éªŒè¯æ³¨è§£çš„å…ƒç´ å€¼ä¸ä¸ºç©ºï¼ˆä¸ä¸ºnullã€å»é™¤é¦–ä½ç©ºæ ¼åé•¿åº¦ä¸º0ï¼‰ï¼Œä¸åŒäº@NotEmptyï¼Œ@NotBlankåªåº”ç”¨äºå­—ç¬¦ä¸²ä¸”åœ¨æ¯”è¾ƒæ—¶ä¼šå»é™¤å­—ç¬¦ä¸²çš„ç©ºæ ¼
@Email(id: string,message?: string) |		éªŒè¯æ³¨è§£çš„å…ƒç´ å€¼æ˜¯Email
@Phone(id: string,message?: string) | éªŒè¯å…ƒç´ å€¼æ˜¯æ‰‹æœºå· å…·ä½“æ ¼å¼å‚è€ƒ`https://github.com/validatorjs/validator.js/blob/master/src/lib/isMobilePhone.js`



[å†…ç½®å‚æ•°è£…é¥°å™¨å‚è€ƒæ–‡æ¡£](https://umajs.gitee.io/other/ArgDecorator.html#api)


### æ•°æ®èšåˆ
é€šè¿‡ä»¥ä¸Šå‡ ä¸ªç¤ºä¾‹ï¼Œç›¸ä¿¡å¤§å®¶å¯¹äº Umajs å‚æ•°è£…é¥°å™¨çš„ä¾¿æ·ä¹‹å¤„æœ‰äº†ä¸€å®šçš„è®¤è¯†ã€‚ç„¶è€Œå®é™…å¼€å‘ä¸­æˆ‘ä»¬è¿˜éœ€è¦é¢å¯¹ä¸€äº›æ›´å¤æ‚çš„åœºæ™¯ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œç¬¬ä¸‰æ–¹æ¥å£æ‰€éœ€çš„ DTOï¼ˆData Transfer Objectï¼‰å…¶å±æ€§ä¸€éƒ¨åˆ†å¯èƒ½æ¥è‡ªäº paramã€queryï¼Œå¦ä¸€éƒ¨åˆ†åˆ™å¯èƒ½æ¥è‡ªäº Cookie ç”šè‡³æ˜¯ç¬¬ä¸‰æ–¹æœåŠ¡ã€‚

ä¾‹å¦‚ä¸‹é¢ `UserDTO` ä¸­ï¼Œ`uname` æ¥è‡ªäº paramï¼Œ`role` åˆ™æ¥è‡ªäº queryï¼Œè€Œ `operator` åˆ™æ˜¯æ ¹æ® Cookie ä» sso service ä¸­è·å–ï¼š

![dto](./docs/imgs/dto.png)

æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å‚æ•°è£…é¥°å™¨æ¥å°è£…è¿™äº›ç¹ççš„ã€ä»ä¸åŒåœ°æ–¹è·å–å­—æ®µå€¼çš„æ“ä½œï¼š

```TS
// decorator/UserDTO.ts
export const GetUser = createArgDecorator(
    (ctx: IContext) => {
        const user = new UserDTO();

        user.uname = ctx.param.uname;
        user.role = ctx.query.role || 'user';
        user.operator = ctx.uid || 10269;

        return user;
    },
);
```
åœ¨ Controller æ–¹æ³•é‡Œç›´æ¥é€šè¿‡ `@GetUser` è·å–å¹¶ä½¿ç”¨ç›¸åº”çš„ DTO å®ä¾‹ï¼š
```TS
// controller/index.controller.ts
@Path('/user/:uname')
addUser(@GetUser() dto: UserDTO) {
    const data = this.userService.addUser(dto);

    return Result.json(data);
}
```

### å‚æ•°è£…é¥°å™¨å°ç»“

<br>

![arg_decorator](./docs/imgs/arg_decorator.png)

<br>

é€šè¿‡ä»¥ä¸Šå‡ ä¸ªç¤ºä¾‹ä¸ºå¤§å®¶å±•ç¤ºäº† Umajs å‚æ•°è£…é¥°å™¨æ˜¯å¦‚ä½•å®ç°å¯¹å‚æ•°çš„å¿«é€Ÿè·å–ã€æ ¡éªŒã€è½¬æ¢åŠèšåˆã€‚é’ˆå¯¹å¸¸ç”¨åœºæ™¯ Umajs æä¾›äº†ä¸€ç³»åˆ—çš„å†…ç½®å‚æ•°è£…é¥°å™¨ã€‚

![req_model](./docs/imgs/req_model.png)

é’ˆå¯¹å¤æ‚åœºæ™¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ä¸€ä¸ªå¼ºå¤§çš„å‚æ•°è£…é¥°å™¨ä»¥å®ç°è·å–ã€æ ¡éªŒã€èšåˆä¸€ä½“ï¼Œä»è€Œåˆ†ç¦»ä¸šåŠ¡é€»è¾‘ä¸å…¶å®ƒé€»è¾‘ï¼Œå®ç°ä»£ç çµæ´»å¤ç”¨ã€‚



## è¿”å›å¤„ç†ç»“æœ

### æ‹¦æˆªå¹¶æ›¿æ¢è¿”å›å€¼

æˆ‘ä»¬å…ˆçœ‹ä¸€æ®µç¤ºä¾‹ä»£ç ï¼š

```ts
// decorator/AgeCheck.ts
export const AgeCheck = createArgDecorator(
    (ctx: IContext, ageKey: string) => {
        let age = ctx.query[ageKey];

        if (age === undefined) {
            return Result.json({
                code: 0,
                msg: 'è¯·åŠ ä¸Š age å‚æ•°',
            });
        }

        age = +age;

        if (Number.isNaN(age) || age < 0 || age > 120) {
            return Result.json({
                code: 0,
                msg: 'è¯·ä¼ å…¥æ­£ç¡®çš„ age å‚æ•°',
            });
        }
        return age;
    }
);
```

æƒ³å¿…æœ‹å‹ä»¬ä¹Ÿå‘ç°äº†ï¼Œåˆæ˜¯è¿™ä¸ª `AgeCheck` çš„ä»£ç ã€‚æ”¾å¿ƒï¼Œä»£ç æ²¡æœ‰ç²˜é”™ğŸ˜ ã€‚åœ¨è¿™ä¸ªç« èŠ‚é‡Œæˆ‘ä»¬çš„å…³æ³¨ç‚¹å’Œä¸Šä¸€ç« æœ‰æ‰€ä¸åŒï¼šç›¸ä¿¡å¤§å®¶éƒ½æ³¨æ„åˆ°äº†ï¼Œå½“å‚æ•°æ ¡éªŒæœªé€šè¿‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡ `return Result.json(data)` è¿™æ®µä»£ç æŠŠå¯¹åº”çš„é”™è¯¯ä¿¡æ¯æŠ›ç»™äº†æ¥å£ã€‚

è¿™å°±æ˜¯ Umajs çš„ç»Ÿä¸€è¿”å›æœºåˆ¶: åœ¨ Controller çš„æ–¹æ³•é‡Œè¿”å› `Result` è€Œä¸æ˜¯ç›´æ¥æ“ä½œ `context`ã€‚ç»Ÿä¸€è¿”å›æœ¬è´¨ä¸Šä»æ˜¯å¯¹å¦‚ä¸‹ä¼ ç»Ÿæ–¹å¼çš„åŒ…è£…ï¼Œå¹¶ä¸” Umajs ä»ç„¶æ”¯æŒä¼ ç»Ÿçš„æ–¹å¼ã€‚

```TS
ctx.body = 'happy hacking';
ctx.status = 200;
```

ä½†æ˜¯ä¼ ç»Ÿæ–¹å¼å¦‚æœæƒ³é€šè¿‡è£…é¥°å™¨å¯¹è¿”å›ç»“æœè¿›è¡Œä¿®æ”¹æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œè€Œä½¿ç”¨äº†ç»Ÿä¸€è¿”æœºåˆ¶åˆ™ç›¸å½“ç®€å•ã€‚è­¬å¦‚ä¸Šè¿° `AgeCheck` è£…é¥°å™¨ï¼Œåœ¨æ ¡éªŒæœªé€šè¿‡åå¯ä»¥ç›´æ¥è¿”å› `Result`ï¼Œè¿™ä¸ªè¿”å›å€¼ä»£æ›¿äº†è¢«ä¿®é¥°çš„ Controller æ–¹æ³•çš„è¿”å›å€¼ï¼›å¯¹æ¯”åœ¨æ²¡æœ‰ç»Ÿä¸€è¿”å›çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸æ˜¯æ–¹ä¾¿äº†å¾ˆå¤šï¼Ÿ

### ä¿®æ”¹å½“å‰è¿”å›å€¼

`AgeCheck` è£…é¥°å™¨æ¼”ç¤ºäº†å¯¹è¿”å›å€¼çš„æ›¿æ¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¢è®¨ä¸€ä¸‹å¦‚ä½•ä¿®æ”¹è¿”å›å€¼ï¼š

```TS
export default class implements IAspect {
    @Inject(Timestamp)
    timestamp: Timestamp;

    async around(proceedPoint: IProceedJoinPoint<any>) {
        const { proceed, args } = proceedPoint;
        const result = await proceed(...args);
        result.stamp = this.timestamp.getTimestamp();

        return result;
    }
}
```
ä¸Šè¿°ä»£ç æ˜¯ä¸€ä¸ªåˆ‡é¢æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ºè¿”å›å€¼å¢åŠ äº†ä¸€ä¸ªæ—¶é—´æˆ³å­—æ®µã€‚æ˜¯ä¸æ˜¯å¾ˆè½»æ¾å°±å®ç°äº†å¯¹è¿”å›å€¼çš„ä¿®æ”¹ï¼Ÿ

> å…³äºåˆ‡é¢ä»¥åŠ `@Inject` è£…é¥°å™¨ä¼šåœ¨ç¨åè®¨è®ºã€‚

### ç»Ÿä¸€è¿”å›å†…ç½®ç±»å‹åŠæ‰©å±•

ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼ŒUmajs çš„ç»Ÿä¸€è¿”å›æœºåˆ¶å°è£…äº†å¸¸ç”¨çš„è¿”å›ç±»å‹ï¼Œå¦‚ï¼š
- json
- view
- redirect
- stream
- jsonp
- download
- send

å‡å¦‚ä¸Šè¿°è¿™äº›è¿”å›ç±»å‹ä»ä¸è¶³ä»¥åº”å¯¹æŸäº›åœºæ™¯ï¼Œé‚£ä¹ˆç»Ÿä¸€è¿”å›ä¹Ÿæ”¯æŒé€šè¿‡æ’ä»¶çš„æ–¹å¼è‡ªå®šä¹‰æ‰©å±•è¿”å›ç±»å‹ï¼š

![result_extends](./docs/imgs/result_extends.png)

> æ’ä»¶ç›¸å…³ä¼šåœ¨ç¨åè®¨è®ºã€‚

### ç»Ÿä¸€è¿”å›æœºåˆ¶å°ç»“

ä»¥ä¸Šå‡ ä¸ªç¤ºä¾‹ä»‹ç»äº† Umajs çš„ç»Ÿä¸€è¿”å›æœºåˆ¶ï¼Œ ä»¥åŠå¦‚ä½•é€šè¿‡å‚æ•°è£…é¥°å™¨æ‹¦æˆªè¿”å›å€¼ã€é€šè¿‡åˆ‡é¢æ–¹æ³•ä¿®æ”¹è¿”å›å€¼ï¼›ç»Ÿä¸€è¿”å›æœºåˆ¶å†…ç½®äº†å¸¸ç”¨çš„è¿”å›ç±»å‹ï¼Œå¹¶ä¸”æ”¯æŒé€šè¿‡æ’ä»¶è¿›è¡Œæ‰©å±•ã€‚ç»Ÿä¸€è¿”å›æœºåˆ¶çš„æ„ä¹‰ä¸ä»…åœ¨äºå®ƒå°è£…äº†å¸¸è§çš„è¿”å›ç±»å‹ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬èƒ½å¤Ÿå¯¹è¿”å›å€¼è¿›è¡Œä¾¿æ·çš„å¹²æ¶‰ä»¥åº”å¯¹ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚

## åˆ‡é¢

### åˆ‡é¢çš„æ‰§è¡Œ

åœ¨ä¸Šä¸€ç« ä¸­æˆ‘ä»¬æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨åˆ‡é¢ï¼ŒAspectï¼Œä¿®æ”¹äº†è¿”å›å€¼ã€‚Aspect æ˜¯ AOP æ€æƒ³çš„ä¸€ç§å…·ä½“å®ç°ã€‚åœ¨ Umajs ä¸­ Aspect çš„æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š

![aspect](./docs/imgs/aspect.png)

å¯ä»¥çœ‹åˆ°ï¼Œåˆ‡é¢æœ‰å¦‚ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š

- around ç¯ç»•é€šçŸ¥
- before å‰ç½®é€šçŸ¥
- after åç½®é€šçŸ¥
- afterReturing æœ€ç»ˆé€šçŸ¥
- afterThrowing å¼‚å¸¸é€šçŸ¥

é¦–å…ˆæ‰§è¡Œ around çš„ before éƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œ before ï¼Œç„¶åæ˜¯ç›®æ ‡æ–¹æ³•çš„æ‰§è¡Œï¼›

å¦‚æœç›®æ ‡æ–¹æ³•æ‰§è¡Œå¼‚å¸¸ï¼Œåˆ™æ‰§è¡Œ afterï¼Œç„¶åæ‰§è¡Œ afterThrowingï¼›

å¦‚æœç›®æ ‡æ–¹æ³•æ‰§è¡ŒæˆåŠŸï¼Œåˆ™æ‰§è¡Œ around çš„ after éƒ¨åˆ†ï¼Œç„¶åæ‰§è¡Œ afterï¼Œæœ€ååœ¨ç›®æ ‡æ–¹æ³•æˆåŠŸè¿”å›åæ‰§è¡Œ afterReturningï¼›

å¤šä¸ª Aspect çš„æ‰§è¡Œé¡ºåºä¸ºåŒ…è£¹å‹ã€‚

ç»“åˆç¤ºæ„å›¾æ¥çœ‹ï¼Œç›¸ä¿¡å¤§å®¶å¯¹ `Aspect.around` è¿™ä¸ªåˆ‡é¢æ–¹æ³•æœ‰ä¸€ç§è«åçš„äº²åˆ‡æ„Ÿå¯¹ä¸å¯¹ï¼Ÿæ²¡é”™ï¼Œå®ƒä¸ Koa å¤§åé¼é¼çš„**æ´‹è‘±æ¨¡å‹**åŸºæœ¬ä¸€è‡´ã€‚

### åˆ‡é¢çš„ä½¿ç”¨
```TS
// aspect/test.aspect.ts
export default class implements IAspect {
    before() {
        console.log('test: this is before');
    }
    // å…¶å®ƒé€šçŸ¥ç•¥
}
// controller/index.controller.ts
@Aspect.before('test')
export default class Index extends BaseController {
    @Aspect('auth')
    @Path('/users/:id')
    getUser(@Param('id') uid: string, @Query('role') role: string) {
        // å…¶å®ƒä»£ç ç•¥
        return Result.json({ role });
    }
}
```
é€šè¿‡ä¸Šè¿°ç¤ºä¾‹ä»£ç ï¼Œå¯ä»¥çœ‹å¾—å‡ºï¼š
- `@Aspect` è£…é¥°å™¨æ—¢å¯ä»¥ä¿®é¥°ç±»ï¼Œä¹Ÿå¯ä»¥ä¿®é¥°ç±»çš„æ–¹æ³•ï¼›
- `@Aspect` ä¿®é¥°ç±»çš„æ—¶å€™ï¼Œå¯¹ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½ç”Ÿæ•ˆï¼›
- `@Aspect` æ—¢å¯ä»¥é»˜è®¤ä½¿ç”¨æ‰€æœ‰é€šçŸ¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `@Aspect.before` è¿™ç§æ–¹å¼æŒ‡å®šç‰¹å®šçš„é€šçŸ¥ï¼›

### Aspect.around

åœ¨ Aspect çš„äº”ç§é€šçŸ¥ä¸­ï¼Œï¼Œä»å®ƒä»¬çš„å‡½æ•°ç­¾åå°±å¯ä»¥çœ‹å¾—å‡º,`Aspect.around` æ˜¯æ¯”è¾ƒç‰¹åˆ«çš„ä¸€ä¸ªã€‚åœ¨ Umajs ä¸­ï¼Œå®ƒä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªèƒ½å¤Ÿä¿®æ”¹è¿”å›å€¼çš„é€šçŸ¥ç±»å‹ï¼š

```TS
export interface IAspect {
    before?(point: IJoinPoint): void;
    after?(point: IJoinPoint): void;
    around?(proceedPoint: IProceedJoinPoint): Promise<Result>;
    afterReturning?(point: IJoinPoint, val: any): void;
    afterThrowing?(err: Error): void;
}

export interface IProceedJoinPoint<T = any> extends IJoinPoint<T> {
    proceed(...props: any[]): Promise<any>;
}

export interface IJoinPoint<T = any> {
    target: T;
    args: Array<any>;
}
```

ä¸ºä»€ä¹ˆåªæœ‰ `Aspect.around` èƒ½å¤Ÿä¿®æ”¹è¿”å›å€¼å‘¢ ï¼Ÿ é€šè¿‡å‡½æ•°ç­¾åæˆ‘ä»¬çœ‹å¾—å‡º `Aspect.around` çš„åˆ‡ç‚¹ç±»å‹ç›¸æ¯”å…¶ä»–é€šçŸ¥å¤šäº†ä¸€ä¸ª `proceed`ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯è¢«ç¯ç»•é€šçŸ¥æ‰€ä¿®é¥°çš„ç›®æ ‡æ–¹æ³•ï¼Œæ‰§è¡Œè¿™ä¸ªå‡½æ•°è‡ªç„¶ä¼šè¿”å›ç›®æ ‡æ–¹æ³•çš„è¿”å›å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ `Aspect.around` è¿™é‡Œä¿®æ”¹ç›®æ ‡æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸æ˜¯ä¹Ÿæ˜¾å¾—å’Œåˆç†å‘¢ï¼Ÿ

å¦ä¸€æ–¹é¢ï¼Œå®ƒçš„ç‰¹åˆ«ä¹‹å¤„è¿˜åœ¨äºå®ƒå’Œ Koa ä¸­é—´ä»¶ä¸€æ ·éƒ½å±äºæ´‹è‘±æ¨¡å‹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹è¿™ä¸¤è€…ã€‚

å…±åŒç‚¹ï¼š
- ä¸¤è€…éƒ½æ˜¯æ´‹è‘±æ¨¡å‹ï¼ŒåŒ…è£¹ç°æœ‰æ–¹æ³•ï¼›
- ä»–ä»¬éƒ½èƒ½å¤Ÿæ‹¦æˆªç°æœ‰æ–¹æ³•ã€è¿›è¡Œé”™è¯¯å¤„ç†ç­‰ç­‰ï¼›

å·®å¼‚ç‚¹ï¼š
- `Aspect.around` é’ˆå¯¹ç›®æ ‡æ–¹æ³•ç”Ÿæ•ˆï¼Œè€Œä¸­é—´ä»¶é’ˆå¯¹è¯·æ±‚ç”Ÿæ•ˆï¼›
- `Aspect.around` èƒ½å¤Ÿå¯¹ç›®æ ‡æ–¹æ³•çš„å‚æ•°å’Œè¿”å›ç»“æœè¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸­é—´ä»¶æ— æ³•å¤„ç†è¿™äº›ï¼›

è€Œä¸ºäº†åˆ©ç”¨ Koa ç¤¾åŒºä¸°å¯Œçš„ä¸­é—´ä»¶èµ„æºï¼ŒUmajs æä¾›äº† `middlewareToAround` æ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬èƒ½å¤Ÿä»¥ `Aspect.around` çš„æ–¹å¼æ¥ä½¿ç”¨ä¸­é—´ä»¶ï¼š


```TS
import { IAspect, middlewareToAround } from '@umajs/core';
import mw from 'demo-middleware';
// aspect/middleware.aspect.ts
export default class implements IAspect {
    around = middlewareToAroundï¼ˆmw()ï¼‰
}
```

è¿™ç§è½¬æ¢æ–¹å¼é€‚ç”¨äºæœ‰å±€éƒ¨åŠ è½½éœ€æ±‚çš„ä¸­é—´ä»¶ï¼Œè½¬æ¢åä¸ä½†ä»£ç ç»“æ„æ›´åŠ æ¸…æ™°ï¼Œå…¶æ€§èƒ½ä¹Ÿæœ‰ä¸€å®šçš„æå‡ã€‚

è€Œå¯¹äºæœ‰å…¨å±€åŠ è½½éœ€æ±‚çš„ä¸­é—´ä»¶ï¼Œå¯ä»¥é€šè¿‡ Umajs çš„æ’ä»¶å½¢å¼æ¥ä½¿ç”¨ä¸­é—´ä»¶ã€‚

### åˆ‡é¢åº”ç”¨åœºæ™¯

![aspect_use](./docs/imgs/aspect_use.png)

Aspect çš„åº”ç”¨åœºæ™¯å¯ä»¥è¯´æ˜¯éå¸¸å¹¿æ³›ï¼Œé™¤äº†æˆ‘ä»¬ä¹‹å‰æåˆ°çš„å¯¹äºå‚æ•°ã€è¿”å›å€¼çš„å¤„ç†ï¼Œè¿˜æœ‰ä¾‹å¦‚åŸ‹ç‚¹\æ—¥å¿—ã€æ€§èƒ½ç›‘æ§ã€äº‹åŠ¡æ€§æ“ä½œç­‰ç­‰ã€‚


### åˆ‡é¢å°ç»“

ä»¥ä¸Šå‡ ä¸ªç¤ºä¾‹ä»‹ç»äº†ï¼š
- Umajs çš„ Aspect æ‰§è¡Œæœºåˆ¶ï¼›
- Aspect çš„å¤šç§ä½¿ç”¨æ–¹å¼ï¼›
- `Aspect.around` è¿™ä¸ªé€šçŸ¥çš„å¼ºå¤§ä¹‹å¤„ä»¥åŠå®ƒä¸ Koa ä¸­é—´ä»¶çš„å¼‚åŒï¼›
- `middlewareToAround` æ–¹æ³•èƒ½å¤Ÿå°†ä¸­é—´ä»¶å¿«é€Ÿè½¬æ¢ä¸º `Aspect.around`ï¼›
- å¯¹äºæœ‰å…¨å±€åŠ è½½éœ€æ±‚çš„ä¸­é—´ä»¶ï¼Œå¯ä»¥é€šè¿‡ Umajs çš„æ’ä»¶å½¢å¼æ¥ä½¿ç”¨ä¸­é—´ä»¶ã€‚


## å‚æ•°è£…é¥°å™¨ã€ç»Ÿä¸€è¿”å›ã€åˆ‡é¢å°ç»“

![method](./docs/imgs/method.png)

åœ¨ä»¥ä¸Šä¸‰ä¸ªå°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¸ºå¤§å®¶åˆ†åˆ«æ¼”ç¤ºè®²è§£äº† Umajs çš„å‚æ•°è£…é¥°å™¨ã€ç»Ÿä¸€è¿”å›å’Œåˆ‡é¢ä»¥åŠä»–ä»¬çš„åº”ç”¨ã€‚

å®é™…å¼€å‘ä¸­ï¼Œä¸°å¯Œçš„å‚æ•°è£…é¥°å™¨å¿«é€Ÿå¤„ç†è¾“å…¥ + ç»Ÿä¸€è¿”å›æœºåˆ¶æä¾›è¾“å‡º + Aspect æŒ‰éœ€ä¿®æ”¹ä¿®æ”¹å‚æ•°ã€è¿”å›å€¼çš„æœ‰æœºç»“åˆï¼Œå¯ä»¥è¯´æ˜¯èƒ½å¤Ÿè½»æ¾åº”å¯¹ç»å¤§å¤šæ•°çš„å¤æ‚ä¸šåŠ¡åœºæ™¯ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆæ•¢è‡ªç§° Umajs æ˜¯ä¸€ä¸ªç®€å•å¥½ç”¨çš„æ¡†æ¶ã€‚

è€Œä¸”æ— è®ºæ˜¯å‚æ•°è£…é¥°å™¨è¿˜æ˜¯ç»Ÿä¸€è¿”å›æœºåˆ¶éƒ½æä¾›äº†å¼ºå¤§çš„è‡ªå®šä¹‰æ–¹æ³•ï¼Œåœ¨æ¡†æ¶æœ¬èº«ä¸æ»¡è¶³ä¸šåŠ¡éœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿçµæ´»çš„è¿›è¡Œè‡ªå®šä¹‰æ‰©å±•ã€‚

## æ’ä»¶

Umajs æ’ä»¶çš„æœºåˆ¶å€Ÿç”¨äº† Koa ä¸­é—´ä»¶æœºåˆ¶ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ç®€å•çš„é…ç½®å°±èƒ½å¤Ÿåœ¨ Umajs ä¸­ä»¥æ’ä»¶çš„å½¢å¼ä½¿ç”¨ Koa ä¸­é—´ä»¶ã€‚åœ¨å…¶åŸºç¡€ä¹‹ä¸Š Umajs å°†æ’ä»¶æœºåˆ¶å®ç°ä¸ºæ¡†æ¶çº§æ‰©å±•æ–¹æ¡ˆï¼šä¾‹å¦‚é€šè¿‡å¤åˆæ’ä»¶å®ç°å¯¹ `context`ã€`request`ã€`response`ã€`results` çš„æ‰©å±•ç­‰ç­‰ã€‚

### ä¸­é—´ä»¶è½¬æ’ä»¶
åœ¨ Umajs ä¸­ä»¥æ’ä»¶çš„æ–¹å¼ä½¿ç”¨ä¸­é—´ä»¶æ˜¯éå¸¸ç®€å•çš„äº‹æƒ…ï¼š

é¦–å…ˆåœ¨æ’ä»¶ä¸­å¼•å…¥ä¸­é—´ä»¶ï¼Œå¹¶ä¸”æ ¹æ®åœºæ™¯ç®€å•çš„å£°æ˜å…¶é…ç½®é¡¹ï¼›
```TS
// plugins/test/index.ts
import mw from '../../utils/mw';

export default (uma: Uma, options: any = {}): TPlugin => {
    return {
        use: {
            handler: mw,
        },
    };
};

// config/plugin.config.ts
'test': {
    enable: true,
},
```
ç„¶ååœ¨æ’ä»¶é…ç½®æ–‡ä»¶ä¸­è®¾ç½®å…¶é…ç½®é¡¹ï¼Œè¿™ä¸ªä¸­é—´ä»¶å°±ç”Ÿæ•ˆäº†ã€‚


### æ’ä»¶å®ç°è¿”å›ç±»å‹æ‰©å±•

åœ¨ç»Ÿä¸€è¿”å›æœºåˆ¶ä¸€èŠ‚ï¼Œæˆ‘ä»¬æåˆ°è¿‡ï¼Œå½“å†…ç½®çš„è¿”å›ç±»å‹ä¸è¶³ä»¥æ»¡è¶³ä¸šåŠ¡åœºæ™¯çš„æ—¶å€™å¯ä»¥é€šè¿‡æ’ä»¶æœºåˆ¶æ¥è‡ªå®šä¹‰è¿”å›ç±»å‹ã€‚

å¦‚æœæƒ³è¦æ‰©å±•è¿”å›ç±»å‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆè¦è‡ªå®šä¹‰ä¸€ä¸ªç»§æ‰¿è‡ª `Result` çš„ç±»ï¼Œåœ¨è¿™ä¸ªç±»ä¸­å£°æ˜æˆ‘ä»¬æ‰€æœŸæœ›è¿”å›ç±»å‹å¯¹åº”çš„æ–¹æ³•ï¼š
```TS
// plugin/result/index.ts
import { IContext, TPlugin, Result as R } from '@umajs/core';

export class Result extends R {
    static redirect2(url: string, status: number) {
        return new Result({
            type: 'redirect2',
            data: {
                url,
                status,
            },
        });
    }
}
```
ç„¶åé€šè¿‡æ’ä»¶æ¥å®ç°è¿™ä¸ªå…·ä½“çš„æ–¹æ³•ï¼š

```TS
export default (): TPlugin => ({
    results: {
        redirect2(ctx: IContext, data: TRedirect2) {
            const { url, status } = data;

            ctx.redirect(url);
            ctx.status = status;
        },
    },
});
```

åœ¨ `config` ä¸­é…ç½®è¯¥æ’ä»¶åå°±å¯ä»¥ä½¿ç”¨æ–°å¢çš„æ–¹æ³•äº†ï¼š

```TS
// config/plugin.config.ts
export default {
    'result': true,
}

// controller
redirect(@Require('url', 'è·³è½¬çš„ url æœªå®šä¹‰') url:string) {
    // ä½¿ç”¨æ‰©å±•åçš„ Result è¿›è¡Œå¸¦çŠ¶æ€ç çš„é‡å®šå‘
    return Result.redirect2(url, 301);
}
```

### å¤åˆæ’ä»¶å…¶å®ƒåº”ç”¨

åˆšåˆšæˆ‘ä»¬é€šè¿‡æ‰©å±•è¿”å›ç±»å‹çš„ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨å¤åˆæ’ä»¶æ‰©å±•æ¡†æ¶ã€‚ä½†æ˜¯å¤åˆæ’ä»¶çš„åº”ç”¨ä¸ä»…äºæ­¤ï¼Œè¿˜æä¾›äº† `use`ã€`filter`ã€`ignore`ã€`method` å››ç§å±€éƒ¨åŠ è½½çš„é…ç½®å½¢å¼ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒæ–‡æ¡£ï¼š


[æ’ä»¶å¼€å‘å‚è€ƒæ–‡æ¡£](https://umajs.gitee.io/%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD/Plugin.html#%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91)

### æ’ä»¶å°ç»“

Umajs ä½¿ç”¨æ’ä»¶è¿›è¡Œæ¡†æ¶å±‚é¢æ‹“å±•:
- å¯ä»¥è½»æ¾ä½¿ç”¨å·²æœ‰çš„ä¸­é—´ä»¶ï¼›
- å¯ä»¥é‡‡ç”¨å¤åˆæ¨¡å¼å¯¹  `context`ã€`request`ã€`response`ã€`results` è¿›è¡Œæ‰©å±•ï¼›
- å¯ä»¥å¯¹ä¸­é—´ä»¶çš„ä½¿ç”¨åœºæ™¯è¿›è¡Œå¿«é€Ÿå¼€å‘ï¼Œä¾‹å¦‚:
    - `filter` å¯¹ç¬¦åˆæ¡ä»¶çš„è·¯ç”±åŠ è½½ä¸­é—´ä»¶ï¼›
    - `ignore` å¯¹ç¬¦åˆæ¡ä»¶ä¹‹å¤–çš„è·¯ç”±åŠ è½½ä¸­é—´ä»¶ï¼›
    - `method` å¯¹ MethodType ç¬¦åˆçš„è¯·æ±‚åŠ è½½ä¸­é—´ä»¶ï¼›


## è°ƒç”¨æœåŠ¡/å…¬å…±æ–¹æ³•

åœ¨ç»Ÿä¸€è¿”å›çš„ç¤ºä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨äº† `@Inject`è£…é¥°å™¨ã€‚è¿™ä¸ªè£…é¥°å™¨ç”¨äºå¯¹å…¬å…±æ–¹æ³•çš„è°ƒç”¨ã€‚

é€šå¸¸æˆ‘ä»¬ä¼šå°†ä¸€äº›é€šç”¨çš„ä¸šåŠ¡é€»è¾‘æˆ–è€…æ›´åº•å±‚çš„æ“ä½œå°è£…ä¸ºæœåŠ¡ã€å·¥å…·ç±»ç­‰ä»¥ä¾¿äºåœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨ã€‚

å…ˆæ¥çœ‹ä¸€æ®µç¤ºä¾‹ä»£ç ï¼š

```TS
// controller/user.controller.ts
import Timestamp from '../utils/timestamp';
import UserService from '../service/user.service';

export default class User extends BaseController {
    @Inject(Timestamp)
    timestamp: Timestamp;

    @Service(UserService)
    userService: UserService;

    @Path('/users/:id')
    getUser(@Param('id') uid: string, @Query('role') role: string) {
        const stamp = this.timestamp.getTimestamp();
        const user = this.userService.getUserById(uid, stamp);

        return Result.json({ ...user, role });
    }
}
```
ä¸Šè¿°ç¤ºä¾‹ä»£ç ä¸­æˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ä¸ªè£…é¥°å™¨ `@Inject` å’Œ `@Service`ã€‚é€šè¿‡è¿™ä¸¤ä¸ªè£…é¥°å™¨æˆ‘ä»¬å¿«é€Ÿçš„è·å–äº†å¯¹åº”å·¥å…·ç±»å’ŒæœåŠ¡ç±»çš„å®ä¾‹ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™ä¸¤ä¸ªè£…é¥°å™¨æ˜¯æ€ä¹ˆåšåˆ°å¿«é€Ÿè·å–åˆ°ç±»çš„å®ä¾‹å‘¢ï¼Ÿ

### IOC
å®é™…ä¸Š `@Inject` å’Œ `@Service` è£…é¥°å™¨æ˜¯ IOC æœºåˆ¶çš„åº”ç”¨ã€‚IOC æ„ä¸ºæ§åˆ¶åè½¬ï¼Œå®ƒæ˜¯ä¾èµ–å€’ç½®åŸåˆ™çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯é¢å‘æ¥å£ç¼–ç¨‹ã€‚IOC çš„å®ç°å€ŸåŠ©äºç¬¬ä¸‰æ–¹å®¹å™¨ï¼Œå¯ä»¥è§£è€¦å…·æœ‰ä¾èµ–å…³ç³»çš„å¯¹è±¡ï¼Œé™ä½å¼€å‘ç»´æŠ¤æˆæœ¬ã€‚

![req_model](./docs/imgs/IOC1.png)

ä¾‹å¦‚ç³»ç»Ÿå†…æœ‰å¦‚ä¸Š Aã€Bã€Cã€D å››ä¸ªæ¨¡å—ï¼Œå®ƒä»¬ç›¸äº’ä¾èµ–ï¼Œå°±åƒå››ä¸ªå’¬åˆåœ¨ä¸€èµ·çš„é½¿è½®ç»„ã€‚è€Œè¿™æ ·ä¸€ä¸ªç³»ç»Ÿï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªæ¨¡å—å‘ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆå¯èƒ½å¯¼è‡´æ•´ä¸ªç³»ç»Ÿéƒ½ä¸å¯ç”¨ã€‚è¿™ä¹Ÿå°±æ˜¯ä»£ç è€¦åˆåº¦è¿‡é«˜å¸¦æ¥çš„é—®é¢˜ã€‚




### ä¾èµ–æ³¨å…¥
IOC å¸¸è§çš„å®ç°æ–¹å¼ã€ä¹Ÿæ˜¯ Umajs æ‰€é‡‡ç”¨çš„æ–¹å¼ï¼Œæ˜¯ä¾èµ–æ³¨å…¥ã€‚é¡¾åæ€ä¹‰æ˜¯æŠŠé«˜å±‚æ¨¡å—æ‰€ä¾èµ–çš„ä½å±‚æ¨¡å—æ³¨å…¥è¿›æ¥ï¼š

![req_model](./docs/imgs/IOC2.png)

é«˜å±‚æ¬¡æ¨¡å—è„±ç¦»äº†ä¸šåŠ¡é€»è¾‘è½¬è€Œæˆä¸ºäº†ä½å±‚æ¬¡æ¨¡å—çš„å®¹å™¨ï¼Œè€Œä½å±‚æ¬¡æ¨¡å—åˆ™é¢å‘æ¥å£ç¼–ç¨‹ï¼šæ»¡è¶³å¯¹é«˜å±‚æ¬¡æ¨¡å—åˆå§‹åŒ–çš„æ¥å£çš„çº¦å®šå³å¯ã€‚è¿™å°±æ˜¯æ§åˆ¶åè½¬ï¼šé€šè¿‡æ³¨å…¥ä¾èµ–å°†æ§åˆ¶æƒäº¤ç»™è¢«ä¾èµ–çš„ä½å±‚çº§æ¨¡å—ã€‚

åœ¨å¼•è¿›äº†ä¸Šå›¾ä¸­é—´çš„å®¹å™¨ä¹‹åï¼Œå‡ ä¸ªé½¿è½®ä¹‹é—´ä¸å†äº’ç›¸å’¬åˆã€å˜æˆäº†é½¿è½®ä¹‹é—´ç›¸äº’ç‹¬ç«‹ä½†éƒ½ä¸å®¹å™¨å’¬åˆã€‚

ä¾èµ–æ³¨å…¥æœ‰å¾ˆå¤šå®ç°æ–¹å¼ï¼Œæ¯”è¾ƒå…¸å‹çš„æ˜¯æ„é€ å‡½æ•°æ³¨å…¥å’Œç±»å±æ€§æ³¨å…¥ã€‚å‡ºäºå¯¹ TypeScript æ”¯æŒç­‰åŸå›  Umajs é‡‡ç”¨äº†ç±»å±æ€§æ³¨å…¥çš„æ–¹æ¡ˆï¼Œä½†æ„é€ å‡½æ•°æ³¨å…¥çš„æ–¹æ¡ˆä¹Ÿæœ‰å¾ˆå¤šä¼˜ç§€çš„å®ç°ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œäº†è§£ä¸€ä¸‹ã€‚

Umajs æä¾›äº† `@Resource` å’Œ `@Inject` æ¥å®ç° IOC å®¹å™¨å’Œä¾èµ–æ³¨å…¥ã€‚ä½¿ç”¨ `@Resource` ä¿®é¥°çš„ç±»ï¼Œæ¡†æ¶å¯åŠ¨æ—¶å°†ä¼šåœ¨ IOC å®¹å™¨ä¸­åŠ å…¥ä¸€ä¸ªè¯¥ç±»çš„å®ä¾‹ã€‚`@Inject` åˆ™å¯ä»¥å°†ç›¸åº”çš„ç¤ºä¾‹æ³¨å…¥åˆ°æŒ‡å®šçš„å˜é‡ä¸­ã€‚

æ‰€ä»¥ä¸Šè¿°ç¤ºä¾‹ä¸­ `@Inject` å®Œæ•´ç¤ºä¾‹å¦‚ä¸‹ï¼š
```ts
// utils/index.ts
@Resource()
export default class Timestamp {
    getTimestamp(date: Date = new Date()) {
        return date.valueOf();
    }
}
// controller
export default class User extends BaseController {
    @Inject(Timestamp)
    timestamp: Timestamp;
    //...
}
```

è€Œ `@Service` åˆ™æ˜¯ Umajs æä¾›çš„ç‰¹æ®Šæ³¨å…¥è£…é¥°å™¨ï¼Œç”¨äºå¿«é€Ÿè·å– `service` å®ä¾‹ï¼Œè¿™ä¸ªè£…é¥°å™¨åªèƒ½åœ¨ç»§æ‰¿è‡ª BaseController çš„ç±»ä¸­ä½¿ç”¨ã€‚

åœ¨æ¡†æ¶å¯åŠ¨æ—¶ä¼šå¯¹ä»£ç è¿›è¡Œæ‰«æï¼Œå½“ä»£ç å‘½åä¸º `*.service.ts` ä¸”ç»§æ‰¿è‡ª `BaseService` æ—¶ï¼Œä¼šå°†å…¶å®ä¾‹åŒ–å¹¶æŠŠå®ä¾‹æ”¾å…¥ Service å®¹å™¨ä¸­ã€‚å› æ­¤ `@Service` è£…é¥°å™¨æ— éœ€åŒ¹é…çš„æ¨¡å—å£°æ˜å³å¯ç”Ÿæ•ˆã€‚

æ­¤å¤– `@Service` ä¿®é¥°å™¨æ‰€æ³¨å…¥çš„å®ä¾‹è¿˜èƒ½å¤Ÿè®¿é—® `context` å¯¹è±¡ï¼Œè€Œé€šè¿‡ `@Resource` ä¿®é¥°çš„ç±»åˆ™ä¸èƒ½ã€‚

## å¼‚å¸¸å¤„ç†

å¦¥å–„çš„å¼‚å¸¸æ•è·ä¸å¤„ç†æ˜¯ç¨‹åºç¨³å®šè¿è¡Œçš„é‡è¦ä¿éšœã€‚åœ¨ Umajs ä¸­æˆ‘ä»¬æ¨èä½¿ç”¨ä»¥ä¸‹å‡ ç§æ–¹å¼è¿›è¡Œé”™è¯¯å¤„ç†ï¼š

![error_handler](./docs/imgs/error_handler.jpg)

ä»–ä»¬çš„åº”ç”¨åœºæ™¯åˆ†åˆ«å¦‚ä¸‹ï¼š

- try-catch: é€‚åˆå¯¹æ–¹æ³•å•ç‹¬è¿›è¡Œé”™è¯¯å¤„ç†
- Aspect: æ›´å…·å¯å¤ç”¨æ€§ï¼Œå¯ä»¥å¯¹å¤šä¸ªæ–¹æ³•è¿›è¡Œé”™è¯¯å¤„ç†
- plugin-status: å¯¹æ•´ä¸ªç³»ç»Ÿåœ¨è¿è¡Œä¸­æœªè¢«æ•è·çš„é”™è¯¯çš„å…œåº•æ“ä½œï¼Œè®©ç³»ç»Ÿæ›´å¥å£®ï¼ŒåŒæ—¶é™¤äº†é”™è¯¯å¤„ç†å¤–ï¼Œæ›´å¤šçš„æ˜¯å¯¹ä¸åŒçŠ¶æ€ç çš„ç»Ÿä¸€å¤„ç†

## å°ç»“

- å‚æ•°è£…é¥°å™¨
- ç»Ÿä¸€è¿”å›æœºåˆ¶
- Aspect
- æ’ä»¶
- IOC
- å¼‚å¸¸å¤„ç†
